# Twitter Manager Architecture

## Answers to Your Questions

### 1. What is the use of `codeVerifier` and `codeChallenge`?

**PKCE (Proof Key for Code Exchange)** is a security extension for OAuth 2.0, especially important for mobile apps.

**codeVerifier:**
- A random 128-character string generated by your app
- Kept secret on the client side
- Sent to Twitter when exchanging authorization code for access token
- Proves that your app initiated the OAuth flow

**codeChallenge:**
- SHA256 hash of the codeVerifier, base64url encoded
- Sent to Twitter during the initial authorization request
- Twitter stores this challenge
- When you exchange the code for token, you send the original verifier
- Twitter verifies: `SHA256(verifier) == challenge`

**Why PKCE?**
- Prevents authorization code interception attacks
- Even if someone intercepts the authorization code, they can't exchange it without the verifier
- Required by Twitter for mobile apps using OAuth 2.0

**Flow:**
1. App generates `codeVerifier` (random string)
2. App creates `codeChallenge` = SHA256(`codeVerifier`)
3. App sends `codeChallenge` to Twitter in authorization URL
4. User authorizes → Twitter returns authorization `code`
5. App sends `code` + `codeVerifier` to exchange for token
6. Twitter verifies: SHA256(`codeVerifier`) matches stored `codeChallenge`
7. If match → token is issued

---

### 2. What is the use of `presentationAnchor`?

**presentationAnchor** tells `ASWebAuthenticationSession` which window/view controller to use for presenting the OAuth browser.

**Why it's needed:**
- `ASWebAuthenticationSession` opens a browser/web view for user to sign in
- iOS needs to know which window to present this browser on top of
- Without it, the browser might appear on wrong window or not appear at all

**How it works:**
- `ASWebAuthenticationPresentationContextProviding` protocol requires `presentationAnchor(for:)` method
- Returns a `UIWindow` (the anchor)
- The browser is presented on top of this window
- In our implementation, we:
  1. Try to use provided anchor (if set)
  2. Find the key window from connected scenes
  3. Fallback to creating a new window (shouldn't happen)

**Example:**
```swift
// In your view controller:
let manager = TwitterOAuthManager(...)
manager.setPresentationAnchor(view.window) // Tell it which window to use
```

---

### 3. Why using Factory for Dependency Injection?

**Factory** is a dependency injection framework that:
- Provides type-safe dependency resolution
- Supports protocols (great for testing)
- Thread-safe
- Easy to use and maintain

**Benefits:**
1. **Testability**: Easy to inject mocks
2. **Modularity**: Dependencies are declared, not hardcoded
3. **Lazy Loading**: Dependencies created only when needed
4. **Type Safety**: Compile-time checks
5. **Clean Code**: No manual dependency wiring

**How we use it:**
```swift
// Define in Container extension
var twitterOAuthManager: Factory<TwitterOAuthManager> {
    Factory(self) {
        TwitterOAuthManager(...)
    }
}

// Use anywhere
let manager = Container.shared.twitterOAuthManager()
```

---

### 4. Code Organization (Senior-Level Structure)

The code is now organized into logical modules:

```
TwitterManager/
├── Models/
│   └── TwitterOAuthError.swift          # Error types
├── Utilities/
│   ├── PKCEGenerator.swift              # PKCE generation logic
│   └── Data+Crypto.swift                # Crypto extensions
├── Network/
│   ├── TwitterOAuthURLBuilder.swift     # URL building
│   └── TwitterTokenExchanger.swift      # Token exchange
├── Presentation/
│   └── TwitterOAuthPresentationContextProvider.swift  # UI presentation
├── DIContianer/
│   └── DIContainer.swift                # Factory registrations
├── TwitterOAuthManager.swift             # Main orchestrator
└── TwitterConfig.swift                   # Configuration
```

**Principles:**
- **Single Responsibility**: Each file has one clear purpose
- **Protocol-Oriented**: Protocols for testability
- **Dependency Injection**: All dependencies injected
- **Separation of Concerns**: Network, UI, business logic separated
- **Testability**: Easy to mock and test each component

---

## Architecture Flow

```
TwitterOAuthManager (Orchestrator)
    ├── PKCEGenerator (Generates verifier/challenge)
    ├── TwitterOAuthURLBuilder (Builds auth URL)
    ├── ASWebAuthenticationSession (Opens browser)
    ├── TwitterTokenExchanger (Exchanges code for token)
    └── PresentationContextProvider (Provides UI anchor)
```

---

## Usage Example

```swift
// Using Factory DI
let manager = Container.shared.twitterOAuthManager()
manager.authenticate { result in
    switch result {
    case .success(let token):
        print("Access token: \(token)")
    case .failure(let error):
        print("Error: \(error)")
    }
}
```



